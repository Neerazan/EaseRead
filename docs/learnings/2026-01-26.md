# Learning Journal: 2026-01-26

## Objective: Implementing Professional Full-Text Search (FTS)

Today I learned how to move beyond simple `LIKE` / `ILIKE` patterns to implement a language-aware, professional search system using PostgreSQL's native capabilities. This is fundamental for building a modern "AI-Assisted Reading Companion."

---

### 1. The Core Architecture of Search

In professional applications, search isn't just "finding characters"; it's about "matching concepts."

#### A. Scoped Search vs. Universal Search
- **Scoped Search**: Searching within a specific module (e.g., this library search). It's typically implemented in the same database using native FTS.
- **Universal Search**: Searching across the whole app (Documents, Vocabs, Notes). This eventually requires a dedicated search service or an aggregator pattern.

#### B. Postgres FTS Pillar
| Component | Purpose | Functionality |
| :--- | :--- | :--- |
| **`tsvector`** | **The Document** | A pre-processed, sorted list of tokens (lexemes). It represents *what* targets are searchable. |
| **`tsquery`** | **The Query** | The user's intent transformed into logical operations (AND/OR/NOT). |
| **`@@`** | **The Match** | The engine that compares the vector and query. |

---

### 2. Deep Dive: The `tsvector` Transformation

If we have a document with:
- **Title**: `"Mountain High"`
- **Author**: `"John Doe"`

The SQL operation `to_tsvector('english', title || ' ' || author)` performs the following steps:

1.  **Concatenation**: `"Mountain High John Doe"`
2.  **Tokenization**: Breaks the string into words.
3.  **Normalization**: Lowercases everything.
4.  **Stemming**: Reduces words to roots (e.g., "Mountaineering" would become "mountain").
5.  **Stop-word Removal**: Drops words like "the", "a", "is" (useless for search).

**Final Vector**: `'doe':4 'high':2 'john':3 'mountain':1`
*(The numbers are positions, allowing for proximity searching).*

---

### 3. Key SQL Functions & Technical "Gotchas"

- **The NULL Trap**: In SQL, `NULL + 'some text'` results in `NULL`. If the `author` is empty, the entire search string would disappear.
  - *Fix*: Always use `COALESCE(column, '')`.
- **The Special Character Crash**: If a user types `&` or `|` in a standard `to_tsquery`, the database will throw an error.
  - *Fix*: Use `plainto_tsquery`. It safely sanitizes user input and converts "Moby Dick" into `moby & dick`.
- **Language Sensitivity**: Specifying `'english'` is crucial. It tells Postgres to use the English dictionary for stemming (so "books" matches "book").

---

### 4. Implementation in NestJS (TypeORM QueryBuilder)

We used `QueryBuilder` because standard TypeORM Repository methods (`find({ where: ... })`) do not support native Postgres operators like `@@`.

```typescript
const queryBuilder = this.documentsRepository
  .createQueryBuilder('document')
  .where('document.userId = :userId', { userId }); // ðŸ”’ SECURITY: Always scope by User ID first

if (search) {
  queryBuilder.andWhere(
    "to_tsvector('english', document.title || ' ' || COALESCE(document.author, '')) @@ plainto_tsquery('english', :search)",
    { search },
  );
}
```

---

### 5. Future Scalability: The GIN Index

When the library grows to 100,000+ documents, searching on-the-fly will become slow because Postgres has to compute the `tsvector` for every single row for every search.

**The Professional Upgrade Path**:
1.  **Generated Column**: Create a column `search_vector` that updates automatically.
2.  **GIN Index**: Use a **Generalized Inverted Index** (GIN). Instead of scanning rows, Postgres looks at the index (like an index at the back of a physical book) to find the IDs instantly.
3.  **Vector Search (AI)**: Eventually, we can use `pgvector` for "Semantic Search" (searching by meaning, e.g., finding "sad books" even if the word "sad" isn't in the title).

---

### Summary Checklist for FTS
- [x] Use `tsvector` for language-aware tokenization.
- [x] Use `plainto_tsquery` for safe user input handling.
- [x] Handle `NULL` propagation using `COALESCE`.
- [x] Scope by `userId` before applying search (Multi-tenancy security).
- [x] Implement pagination (`skip/take`) with every search.
